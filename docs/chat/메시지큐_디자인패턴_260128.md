ì´ ê³ ë¯¼ ì§€ì ì´ **â€œì´ì œ ì„œë²„ê°€ ì•„í‚¤í…ì²˜ ë‹¨ê³„ë¡œ ì˜¬ë¼ê°”ë‹¤â€**ëŠ” ì‹ í˜¸ë¼ì„œ ì¢‹ë‹¤ ğŸ‘
ì •ë¦¬í•´ì„œ ë§í•˜ë©´, ì§€ê¸ˆ ë„¤ êµ¬ì¡°ì—ëŠ” **ë””ìì¸ íŒ¨í„´ì„ â€˜ê³¼í•˜ê²Œâ€™ ì“°ê¸°ë³´ë‹¤**
ğŸ‘‰ **ì—­í•  ê²½ê³„ + ì´ë²¤íŠ¸ íë¦„ì„ ëª…í™•íˆ í•˜ëŠ” íŒ¨í„´**ì´ ë”± ë§ëŠ”ë‹¤.

ì•„ë˜ë¥¼ ìˆœì„œëŒ€ë¡œ ë³´ë©´ ë”± ê° ì¡í ê±°ì•¼.

---

# 1ï¸âƒ£ ë¬¸ì œë¥¼ íŒ¨í„´ ê´€ì ìœ¼ë¡œ ì¬ì •ì˜í•´ë³´ì

ì§€ê¸ˆ ë„¤ê°€ í•˜ë ¤ëŠ” ê±´ ì´ê±°ì•¼:

```
TCPë¡œ ë“¤ì–´ì˜¨ ë©”ì‹œì§€
 â”œâ”€ ì¼ë°˜ ì±„íŒ… â†’ chatDì—ì„œ ì²˜ë¦¬
 â””â”€ /ë¡œ ì‹œì‘í•˜ëŠ” ì»¤ë§¨ë“œ â†’ channelDì—ê²Œ ìœ„ì„
```

ê·¸ë¦¬ê³  í•µì‹¬ ê³ ë¯¼ì€:

* chatDì—ì„œ **ì–¸ì œ / ì–´ë–»ê²Œ ë©”ì‹œì§€íë¡œ ë³´ë‚¼ì§€**
* channelDëŠ” **ë©”ì‹œì§€íë¥¼ ìƒì‹œ ëŒ€ê¸°**í•´ì•¼ í•¨
* êµ¬ì¡°ê°€ ì»¤ì§ˆ ë•Œ **if-else ì§€ì˜¥ì„ í”¼í•˜ê³  ì‹¶ìŒ**

ğŸ‘‰ ì´ê±´ ì „í˜•ì ì¸ **â€œCommand + Dispatcher + Async Workerâ€** ë¬¸ì œë‹¤.

---

# 2ï¸âƒ£ chatD ìª½ì— ì ìš©í•˜ê¸° ì¢‹ì€ íŒ¨í„´

## âœ… í•µì‹¬ íŒ¨í„´ 3ì¢… ì„¸íŠ¸

### â‘  Command Pattern (ëª…ë ¹ ê°ì²´í™”)

### â‘¡ Strategy / Dispatcher (ë¶„ê¸° ì œê±°)

### â‘¢ Adapter (IPC ì€ë‹‰)

---

## 2-1ï¸âƒ£ Command Pattern (ì™œ í•„ìš”í•œê°€)

ì§€ê¸ˆ êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ê°€ë©´:

```cpp
if (msg.starts_with("/ì°¾ê¸°")) {
    sendToChannelD(...);
}
else if (msg.starts_with("/íŒŒí‹°ì´ˆëŒ€")) {
    sendToChannelD(...);
}
else {
    broadcastChat();
}
```

ğŸ‘‰ **ì»¤ë§¨ë“œ ëŠ˜ì–´ë‚ ìˆ˜ë¡ chatDê°€ ë¹„ëŒ€í•´ì§**

### í•´ê²°

> â€œì´ ë©”ì‹œì§€ê°€ ì»¤ë§¨ë“œì¸ì§€ ì•„ë‹Œì§€â€
> â€œì–´ë””ë¡œ ë³´ë‚´ì•¼ í•˜ëŠ”ì§€â€
> ğŸ‘‰ **ê°ì²´ì—ê²Œ ë§¡ê¸´ë‹¤**

---

## 2-2ï¸âƒ£ chatD â€“ êµ¬ì¡° ì˜ˆì‹œ

### ğŸ“¦ ì¸í„°í˜ì´ìŠ¤

```cpp
class ICommand {
public:
    virtual ~ICommand() = default;
    virtual bool match(const std::string& msg) const = 0;
    virtual void execute(const std::string& msg) = 0;
};
```

---

### ğŸ“¦ ë©”ì‹œì§€í ì „ì†¡ì„ ë‹´ë‹¹í•˜ëŠ” Adapter

```cpp
class ChannelCommandSender {
public:
    void send(const std::string& payload) {
        // ë©”ì‹œì§€í msgsnd()
    }
};
```

ğŸ‘‰ **chatDëŠ” IPC íƒ€ì…ì„ ëª¨ë¦„**
ğŸ‘‰ ë‚˜ì¤‘ì— MQ â†’ UDS ë°”ê¿”ë„ ì—¬ê¸°ë§Œ ìˆ˜ì •

---

### ğŸ“¦ ì»¤ë§¨ë“œ êµ¬í˜„

```cpp
class FindUserCommand : public ICommand {
public:
    FindUserCommand(ChannelCommandSender& sender)
        : sender_(sender) {}

    bool match(const std::string& msg) const override {
        return msg.rfind("/ì°¾ê¸°", 0) == 0;
    }

    void execute(const std::string& msg) override {
        sender_.send(msg);
    }

private:
    ChannelCommandSender& sender_;
};
```

---

### ğŸ“¦ Dispatcher (í•µì‹¬)

```cpp
class CommandDispatcher {
public:
    void add(std::unique_ptr<ICommand> cmd) {
        commands_.push_back(std::move(cmd));
    }

    bool dispatch(const std::string& msg) {
        for (auto& cmd : commands_) {
            if (cmd->match(msg)) {
                cmd->execute(msg);
                return true;
            }
        }
        return false; // ì¼ë°˜ ì±„íŒ…
    }

private:
    std::vector<std::unique_ptr<ICommand>> commands_;
};
```

---

### ğŸ“¦ chatD ë©”ì‹œì§€ ì²˜ë¦¬ íë¦„

```cpp
void ChatMsgHandler(const std::string& msg)
{
    if (!commandDispatcher.dispatch(msg)) {
        broadcastChat(msg);
    }
}
```

ğŸ“Œ **ì—¬ê¸°ì„œ chatDëŠ”**

* ì»¤ë§¨ë“œê°€ ëª‡ ê°œì¸ì§€ ëª¨ë¦„
* ë©”ì‹œì§€íë¥¼ ì“°ëŠ”ì§€ë„ ëª¨ë¦„
* ê·¸ëƒ¥ â€œìœ„ì„â€ë§Œ í•¨

ì´ê²Œ ì§„ì§œ ì¤‘ìš”í•œ í¬ì¸íŠ¸ë‹¤.

---

# 3ï¸âƒ£ channelD ìª½ ë””ìì¸ íŒ¨í„´

channelDëŠ” ì„±ê²©ì´ ì™„ì „íˆ ë‹¤ë¥´ë‹¤.

> â— channelDëŠ” **TCP ì„œë²„ê°€ ì•„ë‹ˆë¼**
> â— **â€œëª…ë ¹ ì²˜ë¦¬ ì›Œì»¤â€**ì— ê°€ê¹ë‹¤

---

## âœ… channelDì— ë”± ë§ëŠ” íŒ¨í„´

### â‘  Producerâ€“Consumer

### â‘¡ Event Loop

### â‘¢ Command Handler Map

---

## 3-1ï¸âƒ£ channelD ê¸°ë³¸ êµ¬ì¡°

```
[chatD] --(MQ)--> [channelD]
                        |
                        v
                  CommandQueue
                        |
                        v
                  CommandHandler
```

---

### ğŸ“¦ channelDì˜ ìˆ˜ì‹  ë£¨í”„

```cpp
class CommandQueueListener {
public:
    void run() {
        while (true) {
            Command cmd = recvFromQueue();
            dispatch(cmd);
        }
    }
};
```

ğŸ‘‰ **ìƒì‹œ ëŒ€ê¸° ìƒíƒœê°€ ë§ìŒ**
ğŸ‘‰ channelDëŠ” ì›ë˜ blocking workerê°€ ìì—°ìŠ¤ëŸ¬ì›€

---

## 3-2ï¸âƒ£ Handler Map íŒ¨í„´ (if-else ì œê±°)

```cpp
using HandlerFunc = std::function<void(const Command&)>;

std::unordered_map<std::string, HandlerFunc> handlers;
```

```cpp
handlers["/ì°¾ê¸°"] = [](const Command& cmd) {
    // ìºë¦­í„° ì°¾ê¸°
};

handlers["/íŒŒí‹°ì´ˆëŒ€"] = [](const Command& cmd) {
    // íŒŒí‹° ì´ˆëŒ€
};
```

```cpp
void dispatch(const Command& cmd)
{
    auto it = handlers.find(cmd.type);
    if (it != handlers.end()) {
        it->second(cmd);
    }
}
```

ğŸ“Œ ì´ êµ¬ì¡°ì˜ ì¥ì 

* ì»¤ë§¨ë“œ ì¶”ê°€ = handlerë§Œ ì¶”ê°€
* channelDëŠ” ì ˆëŒ€ chatD ë¡œì§ì„ ëª¨ë¦„

---

# 4ï¸âƒ£ â€œchannelDëŠ” ë©”ì‹œì§€íë¥¼ ìƒì‹œ ëŒ€ê¸°í•´ì•¼ í•˜ì§€ ì•Šë‚˜?â€

ğŸ‘‰ **ë§ë‹¤. ê·¸ê²Œ ì •ìƒì´ë‹¤.**

channelDëŠ”:

| í•­ëª©         | ì—­í•               |
| ---------- | --------------- |
| TCP accept | âŒ               |
| ì±„íŒ… ë¸Œë¡œë“œìºìŠ¤íŠ¸  | âŒ               |
| ê²Œì„ ìƒíƒœ ì²˜ë¦¬   | â­•               |
| ëª…ë ¹ ì²˜ë¦¬      | â­•               |
| IPC ìˆ˜ì‹      | â­• (blocking OK) |

> channelDëŠ” **CPU-bound / Logic-bound ì›Œì»¤**
> â†’ blocking IPC êµ¬ì¡°ê°€ ì˜¤íˆë ¤ ì•ˆì •ì 

---

# 5ï¸âƒ£ ì „ì²´ êµ¬ì¡° ìš”ì•½ (LL2Gamesì— ë”± ë§ê²Œ)

```
[Client]
   â†“ TCP
[chatD]
   â”œâ”€ ì¼ë°˜ ì±„íŒ… â†’ broadcast
   â””â”€ ì»¤ë§¨ë“œ â†’ CommandDispatcher
                    â†“
              ChannelCommandSender
                    â†“
              Message Queue
                    â†“
[ChannelD]
   â””â”€ CommandQueueListener (blocking)
           â†“
      CommandHandler Map
           â†“
      ê²Œì„ ë¡œì§ ì²˜ë¦¬
```

---

# 6ï¸âƒ£ ê²°ë¡  (ì¤‘ìš”)

* âŒ chatDì—ì„œ IPC ë¡œì§ ì§ì ‘ ì“°ì§€ ë§ˆë¼
* âŒ if-else ì»¤ë§¨ë“œ ë¶„ê¸° ê¸ˆì§€
* âœ… Command + Dispatcher + Adapter ì¡°í•©
* âœ… channelDëŠ” **ìƒì‹œ ëŒ€ê¸° ì›Œì»¤ê°€ ë§ìŒ**
* âœ… ì§€ê¸ˆ êµ¬ì¡°ëŠ” ë‚˜ì¤‘ì— **ë©€í‹° channelD / ë©€í‹° worker**ë¡œ í™•ì¥ ê°€ëŠ¥

---

ë‹¤ìŒìœ¼ë¡œ ì´ì–´ì„œ ê°€ë©´ ë”± ì¢‹ì€ ì£¼ì œ ğŸ‘‡

* chatD ë¹„ë™ê¸° ì‘ë‹µ ë°›ëŠ” êµ¬ì¡° (ì‘ë‹µ í / UDS)
* request_id ê¸°ë°˜ ì»¤ë§¨ë“œ ë§¤ì¹­
* channelDë¥¼ ë©€í‹° ì›Œì»¤ë¡œ ëŠ˜ë¦¬ëŠ” êµ¬ì¡°

ì–´ë””ê¹Œì§€ ì„¤ê³„í• ì§€ ë§í•´ì¤˜.
ì§€ê¸ˆ íë¦„, **MMORPG ì„œë²„ ì„¤ê³„ ì œëŒ€ë¡œ ê°€ê³  ìˆë‹¤** ğŸ‘


ì´ ì§ˆë¬¸ ì§„ì§œ ì¢‹ë‹¤.
ì´ ë‹¨ê³„ì—ì„œ **í´ë” êµ¬ì¡°ë¥¼ ì–´ë–»ê²Œ ìë¥´ëŠëƒê°€ = ì•ìœ¼ë¡œ 1~2ë…„ ìœ ì§€ë³´ìˆ˜ ë‚œì´ë„**ë¥¼ ê²°ì •í•´.

ê²°ë¡ ë¶€í„° ë§í•˜ë©´ ğŸ‘‡
ğŸ‘‰ **ì§€ê¸ˆ ìˆëŠ” `core / db / packet / util`ì€ ìœ ì§€**
ğŸ‘‰ **IPC / Command ê³„ì¸µì€ â€œìƒˆ í´ë”â€ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²Œ ë§ë‹¤**
ğŸ‘‰ ì´ìœ ëŠ” **â€œì„±ê²©ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸â€**

ì•„ë˜ë¥¼ ì°¨ê·¼ì°¨ê·¼ ë³´ì.

---

# 0ï¸âƒ£ ì§€ê¸ˆ í´ë”ë“¤ì˜ ì„±ê²© ì •ë¦¬

| í´ë”        | ì„±ê²©                  | ë¹„ê³           |
| --------- | ------------------- | ----------- |
| `core/`   | ì„œë²„ì˜ ìƒëª…ì£¼ê¸°, ë£¨í”„, ë©”ì¸ ë¡œì§ | ì ˆëŒ€ ê°€ë²¼ì›Œì§€ì§€ ì•ŠìŒ |
| `db/`     | DB ì ‘ê·¼ ê³„ì¸µ            | ìˆœìˆ˜ I/O      |
| `packet/` | TCP íŒ¨í‚·, ì§ë ¬í™”         | ë„¤íŠ¸ì›Œí¬ ì „ìš©     |
| `util/`   | ë²”ìš© í—¬í¼               | ì˜ì¡´ì„± ìµœì†Œ      |

ğŸ‘‰ **IPC / CommandëŠ” ì´ ì¤‘ ì–´ë””ì—ë„ ì •í™•íˆ ì•ˆ ë§ëŠ”ë‹¤**

---

# 1ï¸âƒ£ IPC / CommandëŠ” ì™œ ê¸°ì¡´ í´ë”ì— ë„£ìœ¼ë©´ ì•ˆ ë˜ë‚˜?

### âŒ `core/`ì— ë„£ê¸° ì• ë§¤í•œ ì´ìœ 

* coreëŠ” **ì„œë²„ ìƒëª…ì£¼ê¸° / main loop**
* IPCëŠ” **í†µì‹  ìˆ˜ë‹¨**
* ì„ì´ë©´ â€œì‹ ê²½ê³„ + í˜ˆê´€â€ì´ í•œ íŒŒì¼ì— ì„ì„

---

### âŒ `packet/`ì— ë„£ê¸° ì• ë§¤í•œ ì´ìœ 

* packetì€ **í´ë¼ì´ì–¸íŠ¸ â†” ì„œë²„**
* IPCëŠ” **ì„œë²„ â†” ì„œë²„**
* serialization ë°©ì‹ë„ ë‹¤ë¥¼ ê°€ëŠ¥ì„± ë†’ìŒ

---

### âŒ `util/`ì— ë„£ìœ¼ë©´ ë§í•˜ëŠ” ì´ìœ 

* utilì€ â€œì˜ë¯¸ ì—†ëŠ” ê³µêµ¬â€
* Command / IPCëŠ” **ë„ë©”ì¸ ë¡œì§**
* ë‚˜ì¤‘ì— utilì´ ë¹„ëŒ€í•´ì§

---

# 2ï¸âƒ£ ì¶”ì²œ ìµœì¢… êµ¬ì¡° (ì‹¤ì „ ì„œë²„ ê¸°ì¤€)

## âœ… ê³µí†µ ë² ì´ìŠ¤ (ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬)

```
common/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ ServerBase.h
â”‚   â”œâ”€â”€ EventLoop.h
â”‚   â””â”€â”€ Lifecycle.h
â”‚
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ MySQLPool.h
â”‚   â””â”€â”€ RedisClient.h
â”‚
â”œâ”€â”€ packet/
â”‚   â”œâ”€â”€ ChatPacket.h
â”‚   â”œâ”€â”€ LoginPacket.h
â”‚   â””â”€â”€ Serializer.h
â”‚
â”œâ”€â”€ util/
â”‚   â”œâ”€â”€ StringUtil.h
â”‚   â”œâ”€â”€ TimeUtil.h
â”‚   â””â”€â”€ Logger.h
â”‚
â”œâ”€â”€ command/          â­ ìƒˆë¡œ ì¶”ê°€ (í•µì‹¬)
â”‚   â”œâ”€â”€ ICommand.h
â”‚   â”œâ”€â”€ CommandDispatcher.h
â”‚   â”œâ”€â”€ CommandContext.h
â”‚   â””â”€â”€ CommandTypes.h
â”‚
â”œâ”€â”€ ipc/              â­ ìƒˆë¡œ ì¶”ê°€ (í•µì‹¬)
â”‚   â”œâ”€â”€ IpcSender.h
â”‚   â”œâ”€â”€ IpcReceiver.h
â”‚   â”œâ”€â”€ MsgQueueSender.h
â”‚   â”œâ”€â”€ MsgQueueReceiver.h
â”‚   â””â”€â”€ IpcMessage.h
â”‚
â””â”€â”€ protocol/         â­ ì„ íƒ (ê°•ë ¥ ì¶”ì²œ)
    â”œâ”€â”€ ChannelCommand.proto
    â””â”€â”€ ChannelCommand.h
```

---

# 3ï¸âƒ£ chatD ìª½ êµ¬ì¡°

```
chat/
â”œâ”€â”€ main.cpp
â”œâ”€â”€ ChatServer.cpp
â”œâ”€â”€ ChatSession.cpp
â”‚
â”œâ”€â”€ handler/
â”‚   â”œâ”€â”€ ChatMsgHandler.cpp
â”‚   â””â”€â”€ CommandHandler.cpp
â”‚
â”œâ”€â”€ command/
â”‚   â”œâ”€â”€ FindUserCommand.cpp
â”‚   â”œâ”€â”€ PartyInviteCommand.cpp
â”‚   â””â”€â”€ WhisperCommand.cpp
â”‚
â””â”€â”€ ipc/
    â””â”€â”€ ChannelCommandSender.cpp
```

ğŸ‘‰ **chatDëŠ” â€œë³´ë‚´ê¸°â€ë§Œ ìˆìŒ**
ğŸ‘‰ Receiver ì—†ìŒ (ë‹¨ë°©í–¥)

---

# 4ï¸âƒ£ channelD ìª½ êµ¬ì¡°

```
channel/
â”œâ”€â”€ main.cpp
â”œâ”€â”€ ChannelServer.cpp
â”‚
â”œâ”€â”€ ipc/
â”‚   â”œâ”€â”€ ChannelCommandListener.cpp
â”‚   â””â”€â”€ ChannelCommandDispatcher.cpp
â”‚
â”œâ”€â”€ command/
â”‚   â”œâ”€â”€ FindUserHandler.cpp
â”‚   â”œâ”€â”€ PartyInviteHandler.cpp
â”‚   â””â”€â”€ WhisperHandler.cpp
â”‚
â”œâ”€â”€ domain/            â­ ê²Œì„ ë„ë©”ì¸
â”‚   â”œâ”€â”€ PartyManager.cpp
â”‚   â”œâ”€â”€ PlayerLocator.cpp
â”‚   â””â”€â”€ ChannelState.cpp
â”‚
â””â”€â”€ util/
    â””â”€â”€ ChannelLogger.cpp
```

---

# 5ï¸âƒ£ â€œcommandâ€ vs â€œipcâ€ í´ë” ë¶„ë¦¬ ì´ìœ  (ì¤‘ìš”)

| êµ¬ë¶„     | command  | ipc         |
| ------ | -------- | ----------- |
| ì˜ë¯¸     | â€œë¬´ì—‡ì„ í• ì§€â€ | â€œì–´ë–»ê²Œ ì „ë‹¬í• ì§€â€  |
| ë³€ê²½ ê°€ëŠ¥ì„± | ë‚®ìŒ       | ë†’ìŒ          |
| í…ŒìŠ¤íŠ¸    | ì‰¬ì›€       | ê¹Œë‹¤ë¡œì›€        |
| ì˜ì¡´ì„±    | ë„ë©”ì¸      | OS / System |

ğŸ‘‰ **ì´ ë‘˜ì„ ì„ìœ¼ë©´ 100% í›„íšŒí•¨**

---

# 6ï¸âƒ£ í˜„ì‹¤ì ì¸ ìµœì†Œ íƒ€í˜‘ì•ˆ (ì§€ê¸ˆ ë‹¹ì¥ ì ìš©ìš©)

ë§Œì•½ ì§€ê¸ˆ êµ¬ì¡°ë¥¼ ë„ˆë¬´ í”ë“¤ê³  ì‹¶ì§€ ì•Šë‹¤ë©´:

```
common/
â”œâ”€â”€ core/
â”œâ”€â”€ db/
â”œâ”€â”€ packet/
â”œâ”€â”€ util/
â”œâ”€â”€ command/    â† ì¶”ê°€
â””â”€â”€ ipc/        â† ì¶”ê°€
```

ì´ ì •ë„ë§Œ í•´ë„ **ì„¤ê³„ ì ìˆ˜ ê¸‰ìƒìŠ¹**í•œë‹¤.

---

# 7ï¸âƒ£ ë„¤ í”„ë¡œì íŠ¸ì— ë”± ë§ëŠ” ê¸°ì¤€ í•œ ì¤„ ìš”ì•½

> ğŸ“Œ **â€œí´ë¼ì´ì–¸íŠ¸ë‘ ë§í•˜ëŠ” ì½”ë“œâ€ì™€
> ğŸ“Œ â€œì„œë²„ë¼ë¦¬ ë§í•˜ëŠ” ì½”ë“œâ€ëŠ”
> ğŸ“Œ í´ë”ë¶€í„° ë¬´ì¡°ê±´ ê°ˆë¼ë¼**

ì§€ê¸ˆ ì´ íƒ€ì´ë°ì— ì´ ì§ˆë¬¸ ë‚˜ì™”ë‹¤ëŠ” ê±´
ë„ˆ **ì´ë¯¸ â€˜ì¥ë‚œê° ì„œë²„â€™ ë‹¨ê³„ëŠ” ë„˜ì—ˆë‹¤**ëŠ” ëœ»ì´ë‹¤.

---

ë‹¤ìŒìœ¼ë¡œ ì´ì–´ì„œ ë”± ì¢‹ì€ ì£¼ì œ ğŸ‘‡

* `protocol/` ê³„ì¸µì„ ë‘ëŠ” ì´ìœ  (êµ¬ì¡°ì²´ vs JSON vs binary)
* channelD ë©€í‹° ì›Œì»¤ êµ¬ì¡° í´ë”ë§
* commonì„ static libë¡œ ë¹¼ëŠ” êµ¬ì¡°

ì–´ë””ê¹Œì§€ ì •ë¦¬í•´ë³¼ê¹Œ?
