ì •ë¦¬
ë°©ì‹	íŠ¹ì§•	ì¥ì 	ë‹¨ì 
ê³µìœ  ë©”ëª¨ë¦¬(Shared Memory)	ë©”ëª¨ë¦¬ ì§ì ‘ ê³µìœ , ë¹ ë¥¸ ì†ë„	ë§¤ìš° ë¹ ë¥¸ ì†ë„, ëŒ€ìš©ëŸ‰ ë°ì´í„° ì „ì†¡ íš¨ìœ¨ì 	ë™ê¸°í™” ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ì„±
íŒŒì´í”„(Pipe)	ë‹¨ë°©í–¥, FIFO êµ¬ì¡°,
ë²„í¼ ì‚¬ìš©	êµ¬í˜„ ê°„ë‹¨, ì‚¬ìš© ì‰¬ì›€	ë‹¨ë°©í–¥ í†µì‹ , í”„ë¡œì„¸ìŠ¤ ê´€ê³„ ì œí•œ, ë²„í¼ í¬ê¸° ì œí•œ
ì†Œì¼“(Socket)	ì–‘ë°©í–¥, ë„¤íŠ¸ì›Œí¬ í†µì‹  ì§€ì›, í´ë¼ì´ì–¸íŠ¸-ì„œë²„ ëª¨ë¸	íƒ€ ë„¤íŠ¸ì›Œí¬ í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹ .
ë‹¤ì–‘í•œ í†µì‹  í”„ë¡œí† ì½œ.	ë³µì¡í•œ êµ¬í˜„, ë„¤íŠ¸ì›Œí¬ í†µì‹  ì‹œ ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±
ë©”ì‹œì§€ í(Message Queue)	ë¹„ë™ê¸°, ë©”ì‹œì§€ ê¸°ë°˜, í êµ¬ì¡°	ìœ ì—°í•¨, ë‹¤ì–‘í•œ ë©”ì‹œì§€ ìœ í˜• ì§€ì›, ë³µì¡í•œ í†µì‹  ì í•©	ë©”ì‹œì§€ í¬ê¸° ì œí•œ, ì‹œìŠ¤í…œ ìì› ì œí•œ, ë°ì´í„° ë³µì‚¬ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±

https://cobol98.tistory.com/58



ì •ë¦¬ ì˜í–ˆì–´. ì§€ê¸ˆ êµ¬ì¡° ê³ ë¯¼í•˜ëŠ” í¬ì¸íŠ¸ë„ **ì‹¤ì œ ìƒìš© MMORPG ì„œë²„ë“¤ì´ ê²ªëŠ” ê³ ë¯¼**ì´ë‘ ê±°ì˜ ë™ì¼í•´.
ì¼ë‹¨ ë„¤ê°€ ë§í•œ **ë‘ ê°€ì§€ ì•ˆ**ì„ ì •í™•íˆ ì •ì˜í•˜ê³ , **ì•„í‚¤í…ì²˜Â·ìš´ì˜Â·ì„±ëŠ¥Â·í™•ì¥ì„± ê´€ì **ì—ì„œ ë¹„êµí•´ë³¼ê²Œ.

---

## í˜„ì¬ ì „ì œ ì •ë¦¬

* ë°ëª¬ êµ¬ì„±

  * `LoginD` : ì¸ì¦
  * `WorldD` : ì›”ë“œ ìƒíƒœ, ì±„ë„ ëª©ë¡
  * `ChannelD` : ì‹¤ì œ ê²Œì„ ë¡œì§ (ë§µ, ì „íˆ¬, ì´ë™)
  * `ChatD` : ì±„íŒ…

* êµ¬ì¡° ë³€í™” ì•„ì´ë””ì–´

  * **Channel = ê²Œì„ ë‹¨ìœ„**
  * **ì±„ë„ ë‚´ë¶€ì— ì—¬ëŸ¬ ê°œ ì±„ë„(1/2/3/4)** â†’ ê° ì±„ë„ì€ ì‚¬ì‹¤ìƒ **Shard**
  * ì±„íŒ…ì€ **ì±„ë„ ë‹¨ìœ„ë¡œ ë¶„ë¦¬ë˜ì–´ì•¼ í•¨**

---

# ì•ˆ 1ï¸âƒ£

## ì±„ë„ë³„ ChatD í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ë¡œ ë„ìš°ëŠ” êµ¬ì¡°

> `Channel1 â†” ChatD1`
> `Channel2 â†” ChatD2`

### êµ¬ì¡° ê·¸ë¦¼

```
[ChannelD #1] <â”€â”€IPCâ”€â”€> [ChatD #1]
[ChannelD #2] <â”€â”€IPCâ”€â”€> [ChatD #2]
[ChannelD #3] <â”€â”€IPCâ”€â”€> [ChatD #3]
```

---

### âœ… ì¥ì 

#### 1. **ì™„ì „í•œ ì¥ì•  ê²©ë¦¬**

* ChatD #2 ì£½ì–´ë„ â†’ Channel #2 ì±„íŒ…ë§Œ ì˜í–¥
* ê²Œì„ ë¡œì§ê³¼ ì±„íŒ… ë¡œì§ì´ **í”„ë¡œì„¸ìŠ¤ ë‹¨ìœ„ë¡œ ë¶„ë¦¬**

ğŸ‘‰ ìš´ì˜ ì•ˆì •ì„± **ìµœìƒ**

---

#### 2. **ìŠ¤ì¼€ì¼ë§ì´ ë§¤ìš° ì‰¬ì›€**

* ì±„ë„ 3ë§Œ ìœ ì € í­ì¦?

  * ChatD #3ë§Œ ì¦ì„¤
* í•„ìš”í•˜ë©´

  ```
  Channel3 â†” ChatD3-A
            ChatD3-B
  ```

---

#### 3. **ì½”ë“œ êµ¬ì¡°ê°€ ê¹”ë”**

* ChatD = ì±„íŒ… ì„œë²„
* ChannelD = ê²Œì„ ì„œë²„
* ì±…ì„ ë¶„ë¦¬(SRP)ê°€ ëª…í™•

ğŸ‘‰ **ì¶”í›„ ìŒì„± ì±„íŒ…, ê¸¸ë“œ ì±„íŒ…, ê¸€ë¡œë²Œ ì±„íŒ… í™•ì¥ì— ìœ ë¦¬**

---

#### 4. **ì–¸ì–´/ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶„ë¦¬ ê°€ëŠ¥**

* ChannelD â†’ C++
* ChatD â†’ C++ / Go / Rust / Erlang ë“± ì„ íƒ ê°€ëŠ¥

---

### âŒ ë‹¨ì 

#### 1. **IPC / ë„¤íŠ¸ì›Œí¬ ë¹„ìš©**

* ë¡œì»¬ì´ë¼ë„ ê²°êµ­:

  * TCP / Unix Domain Socket / Shared Memory
* **ì´ˆë‹¹ ì±„íŒ…ëŸ‰ ë§ì•„ì§€ë©´ ë¹„ìš© ëˆ„ì **

---

#### 2. **í”„ë¡œì„¸ìŠ¤ ìˆ˜ ì¦ê°€**

* ì±„ë„ 8ê°œë©´:

  * ChannelD 8ê°œ
  * ChatD 8ê°œ
* ìš´ì˜Â·ë°°í¬Â·ëª¨ë‹ˆí„°ë§ ë³µì¡ë„ ìƒìŠ¹

---

#### 3. **ë™ê¸°í™” ë¡œì§ í•„ìš”**

* ì˜ˆ:

  * ìºë¦­í„° ì…ì¥/í‡´ì¥
  * ì±„ë„ ì´ë™
* ChannelD â†” ChatD ìƒíƒœ ë™ê¸° í•„ìš”

---

### ğŸ”¥ ì–¸ì œ ì´ êµ¬ì¡°ê°€ ì¢‹ì€ê°€?

* **ìƒìš© MMORPG**
* ì±„íŒ… íŠ¸ë˜í”½ì´ ë§ìŒ
* ì¥ì•  ê²©ë¦¬ê°€ ì¤‘ìš”
* â€œê²Œì„ ë¡œì§ ì£½ì§€ ë§ì•„ì•¼ í•œë‹¤â€ê°€ ìµœìš°ì„ 

---

# ì•ˆ 2ï¸âƒ£

## ChannelD ë‚´ë¶€ì— ì±„ë„ë³„ Chat ìŠ¤ë ˆë“œ ìƒì„±

### êµ¬ì¡° ê·¸ë¦¼

```
[ChannelD]
 â”œâ”€ Channel #1 (Thread)
 â”‚   â””â”€ Chat Thread
 â”œâ”€ Channel #2 (Thread)
 â”‚   â””â”€ Chat Thread
 â”œâ”€ Channel #3 (Thread)
 â”‚   â””â”€ Chat Thread
```

---

### âœ… ì¥ì 

#### 1. **êµ¬í˜„ ë‚œì´ë„ ë‚®ìŒ**

* í”„ë¡œì„¸ìŠ¤ 1ê°œ
* ë©”ëª¨ë¦¬ ê³µìœ 
* êµ¬ì¡° ë‹¨ìˆœ

ğŸ‘‰ ì§€ê¸ˆ ë„¤ ë‹¨ê³„ì—ì„œëŠ” **ê°œë°œ ì†ë„ ë§¤ìš° ë¹ ë¦„**

---

#### 2. **ì„±ëŠ¥ ìµœê³ **

* í•¨ìˆ˜ í˜¸ì¶œ ìˆ˜ì¤€
* í/ë½ë§Œ ì˜ ì“°ë©´ IPC ë¹„ìš© ì—†ìŒ

---

#### 3. **ë°°í¬Â·ë””ë²„ê¹… í¸í•¨**

* ë°ëª¬ í•˜ë‚˜
* gdb / ë¡œê·¸ ì¶”ì  ë‹¨ìˆœ

---

### âŒ ë‹¨ì 

#### 1. **ì¥ì•  ì „íŒŒ**

* ì±„íŒ… ìŠ¤ë ˆë“œ deadlock / crash â†’

  * ChannelD ì „ì²´ ì˜í–¥
* ìµœì•…: ê²Œì„ ì„œë²„ ë‹¤ìš´

---

#### 2. **ìŠ¤ì¼€ì¼ë§ ë¶ˆê°€ëŠ¥**

* ì±„ë„ 2 ì±„íŒ…ë§Œ í­ì¦í•´ë„

  * ChannelD ì „ì²´ ì˜í–¥
* CPU ë°”ìš´ë“œê°€ ì‰½ê²Œ ë°œìƒ

---

#### 3. **ì½”ë“œê°€ ë¹ ë¥´ê²Œ ì§€ì €ë¶„í•´ì§**

* ê²Œì„ ë¡œì§ â†” ì±„íŒ… ë¡œì§ ë’¤ì—‰í‚´
* ë½ ì§€ì˜¥ ê°€ëŠ¥ì„± â†‘

---

### ğŸ”¥ ì–¸ì œ ì´ êµ¬ì¡°ê°€ ì¢‹ì€ê°€?

* **ê°œì¸ í”„ë¡œì íŠ¸ / í¬íŠ¸í´ë¦¬ì˜¤**
* ì´ˆê¸° ë²„ì „
* ìœ ì € ìˆ˜ ì ìŒ
* ë¹ ë¥¸ êµ¬í˜„ì´ ëª©í‘œ

---

# í•µì‹¬ ë¹„êµ ìš”ì•½

| í•­ëª©     | ì±„ë„ë³„ ChatD í”„ë¡œì„¸ìŠ¤ | ChannelD ë‚´ë¶€ Chat ìŠ¤ë ˆë“œ |
| ------ | -------------- | -------------------- |
| êµ¬í˜„ ë‚œì´ë„ | âŒ ë†’ìŒ           | âœ… ë‚®ìŒ                 |
| ì„±ëŠ¥     | â—¯              | âœ… ìµœê³                  |
| ì¥ì•  ê²©ë¦¬  | âœ… ë§¤ìš° ì¢‹ìŒ        | âŒ ë§¤ìš° ë‚˜ì¨              |
| ìŠ¤ì¼€ì¼ë§   | âœ…              | âŒ                    |
| ìš´ì˜ ë‚œì´ë„ | âŒ              | âœ…                    |
| ìƒìš© ì í•©ì„± | â­â­â­â­â­          | â­â­                   |

---

# ğŸ’¡ í˜„ì‹¤ì ì¸ ì¶”ì²œ (ë„ˆ ìƒí™© ê¸°ì¤€)

ì§€ê¸ˆ ë„ˆ ìƒí™©(LL2Games, í¬íŠ¸í´ë¦¬ì˜¤, ë‹¨ë… ê°œë°œ)ì„ ê°ì•ˆí•˜ë©´:

### ğŸ”¥ **ì¶”ì²œ ì „ëµ**

> **2 â†’ 1 ë‹¨ê³„ì  ì „í™˜**

1ï¸âƒ£ **1ì°¨**

* ChannelD ë‚´ë¶€ì—

  * Channel Thread
  * Chat Thread
* êµ¬ì¡°ë§Œ **ë¶„ë¦¬ëœ ì¸í„°í˜ì´ìŠ¤**ë¡œ ì„¤ê³„

  ```cpp
  IChatService
  â”œâ”€ LocalChatService (Thread)
  â””â”€ RemoteChatService (ChatD)
  ```

2ï¸âƒ£ **2ì°¨**

* ChatD ë¶„ë¦¬
* ChannelD â†” ChatD IPC ì—°ê²°

ğŸ‘‰ **ì•„í‚¤í…ì²˜ ì„¤ê³„ ëŠ¥ë ¥ + í˜„ì‹¤ì  ê°œë°œë ¥ ë‘˜ ë‹¤ ì–´í•„ ê°€ëŠ¥**

---

ì›í•˜ë©´ ë‹¤ìŒìœ¼ë¡œ:

* **ì‹¤ì œ MMOì—ì„œ ì±„íŒ… ì„œë²„ ë¶„ë¦¬ ì‚¬ë¡€**
* **Channel â†” Chat íŒ¨í‚· ì„¤ê³„**
* **Redis Pub/Sub vs ì§ì ‘ IPC**
* **Thread / Lock ì„¤ê³„ ì˜ˆì‹œ**

ì–´ë””ê¹Œì§€ ê°ˆì§€ ë§í•´ì¤˜.


ì¢‹ì€ ë°©í–¥ìœ¼ë¡œ ì •í™•íˆ ì¡ì•˜ì–´ ğŸ‘
ì§€ê¸ˆ ì§ˆë¬¸ì˜ í•µì‹¬ì€ **â€œì±„ë„ë³„ ChatDë¥¼ ëˆ„ê°€ ë„ìš°ê³ , ChannelD â†” ChatDë¥¼ ì–´ë–¤ IPCë¡œ ë¬¶ëŠ” ê²Œ í˜„ì‹¤ì ìœ¼ë¡œ ì¢‹ì€ê°€â€** ì´ê±°ì•¼.
ì•„ë˜ëŠ” **ì‹¤ì „ MMO ì„œë²„ ê¸°ì¤€ + ë„ˆ í˜„ì¬ ì½”ë“œ ìƒíƒœ(chatD ì´ë¯¸ ìˆìŒ)** ê¸°ì¤€ìœ¼ë¡œ ì •ë¦¬í• ê²Œ.

---

# 1ï¸âƒ£ ChatD ì‹¤í–‰ ì±…ì„: mainD âŒ / ChannelD âœ…

ê²°ë¡ ë¶€í„° ë§í•˜ë©´
ğŸ‘‰ **ChannelDê°€ ìê¸° ì±„ë„ì˜ ChatDë¥¼ ì§ì ‘ ì‹¤í–‰ì‹œí‚¤ëŠ” êµ¬ì¡°ê°€ ë§ë‹¤**

---

## âŒ mainDì—ì„œ ChatDë¥¼ ë„ìš°ëŠ” ê²½ìš° ë¬¸ì œ

* mainDëŠ”:

  * Login / World / Channel ì „ì²´ë¥¼ ì´ê´„
* ì—¬ê¸°ì„œ ChatDê¹Œì§€ ê´€ë¦¬í•˜ë©´:

  * ì±„ë„ ìŠ¤ì¼€ì¼ë§ ì‹œ mainD ìˆ˜ì • í•„ìš”
  * ì±„ë„ë³„ ì¥ì•  ê²©ë¦¬ ì–´ë ¤ì›€

---

## âœ… ChannelDê°€ ChatDë¥¼ ì‹¤í–‰í•˜ëŠ” êµ¬ì¡° (ì¶”ì²œ)

### ì‹¤í–‰ êµ¬ì¡°

```
mainD
 â””â”€ ChannelD #1
     â”œâ”€ Game Threads
     â””â”€ ChatD #1 (fork/exec)
 â””â”€ ChannelD #2
     â”œâ”€ Game Threads
     â””â”€ ChatD #2
```

### ì´ìœ 

* Channel = ë…ë¦½ shard
* ChatDëŠ” Channelì˜ **ë¶€ì† ì„œë¹„ìŠ¤**
* ChannelDê°€ ì£½ìœ¼ë©´ ChatDë„ ê°™ì´ ë‚´ë ¤ê°€ë„ ë¬´ë°©

ğŸ‘‰ **ìš´ì˜/ê°œë…ì ìœ¼ë¡œ ê°€ì¥ ìì—°ìŠ¤ëŸ¬ì›€**

---

## ChannelDì—ì„œ ChatD ì‹¤í–‰ ì˜ˆì‹œ (Linux)

```cpp
pid_t pid = fork();
if (pid == 0) {
    execl("./chatD",
          "chatD",
          "--channel-id", "1",
          "--ipc", "unix:/tmp/chat_1.sock",
          nullptr);
    exit(1);
}
```

* ChannelDê°€:

  * channel_id
  * IPC endpoint
* ë¥¼ ChatDì— ë„˜ê²¨ì¤Œ

---

# 2ï¸âƒ£ ChannelD â†” ChatD IPC ì„¤ê³„ (ì¤‘ìš”)

ì±„íŒ…ì€ **íŠ¸ë˜í”½ ë§ê³ , ì§€ì—° ë¯¼ê°**
â†’ IPC ì„ íƒì´ í•µì‹¬

---

## IPC í›„ë³´ ìš”ì•½
IPCëŠ” í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹ (Inter-Process Communication)

| IPC ë°©ì‹             | ì¶”ì²œë„   | ì´ìœ               |
| ------------------ | ----- | --------------- |
| Unix Domain Socket | â­â­â­â­â­ | ë¹ ë¦„ + ì•ˆì • + êµ¬í˜„ ì‰¬ì›€ |
| TCP (localhost)    | â­â­â­â­  | ë©€í‹° ë¨¸ì‹  ëŒ€ë¹„        |
| Shared Memory      | â­â­    | ë½/ë²„ê·¸ ì§€ì˜¥         |
| Redis Pub/Sub      | â­â­â­   | ê¸€ë¡œë²Œ ì±„íŒ…ìš©         |
| gRPC               | â­â­    | ì˜¤ë²„í—¤ë“œ í¼          |

ğŸ‘‰ **ì±„ë„ ì±„íŒ…ì€ UDS(Unix Domain Socket) 1í”½**

---

# 3ï¸âƒ£ ì¶”ì²œ êµ¬ì¡°: Unix Domain Socket + ë©”ì‹œì§€ í

## ì „ì²´ íë¦„

```
[Client]
   â†“
[ChannelD] â”€â”€UDSâ”€â”€â–¶ [ChatD]
   â†‘                  â†“
   â””â”€â”€â”€â”€ ê²°ê³¼ ì „ë‹¬ â”€â”€â”€â”˜
```

---

## IPC ë©”ì‹œì§€ ë‹¨ìœ„ ì„¤ê³„ (í•µì‹¬)

### ê³µí†µ íŒ¨í‚· í—¤ë”

```cpp
struct ChatMsgHeader {
    uint16_t type;
    uint16_t length;
};
```

---

### ì˜ˆì‹œ 1ï¸âƒ£ ì±„íŒ… ì „ì†¡

```cpp
enum {
    CHAT_REQ_SEND = 1,
    CHAT_RES_BROADCAST = 2
};

struct ChatReqSend {
    uint64_t characterId;
    uint32_t channelId;
    char message[256];
};
```

ChannelD â†’ ChatD:

```cpp
send(chat_sock, &packet, sizeof(packet), 0);
```

---

### ì˜ˆì‹œ 2ï¸âƒ£ ChatD ë‚´ë¶€ ì²˜ë¦¬

```cpp
void handle_send(const ChatReqSend& req) {
    for (auto& user : channel_users) {
        send(user.sock, req.message, strlen(req.message), 0);
    }
}
```

ğŸ‘‰ ChatDëŠ”:

* **ì±„íŒ…ë§Œ ë‹´ë‹¹**
* ìºë¦­í„° ìƒíƒœ, ìœ„ì¹˜ ëª°ë¼ë„ ë¨

---

### ì˜ˆì‹œ 3ï¸âƒ£ ChannelD ìˆ˜ì‹  ì²˜ë¦¬

```cpp
ChatResBroadcast res;
recv(chat_sock, &res, sizeof(res), 0);

auto* player = player_mgr.find(res.characterId);
player->send_chat(res.message);
```

---

# 4ï¸âƒ£ ì„±ëŠ¥ì„ ì‚´ë¦¬ëŠ” í•µì‹¬ í¬ì¸íŠ¸ (ì¤‘ìš”)

## â‘  ë¹„ë™ê¸° í í•„ìˆ˜

ì ˆëŒ€ ì´ë ‡ê²Œ í•˜ë©´ ì•ˆ ë¨ âŒ

```cpp
send();
recv(); // blocking
```

### ì¶”ì²œ êµ¬ì¡°

```
ChannelD
 â”œâ”€ Game Thread
 â”œâ”€ Chat IPC Send Thread
 â””â”€ Chat IPC Recv Thread
```

* lock-free queue or mutex queue
* epoll ê¸°ë°˜ IPC

---

## â‘¡ ChannelDëŠ” ChatD ê²°ê³¼ë¥¼ "ì „ë‹¬ë§Œ"

* í•„í„°ë§ âŒ
* ê°€ê³µ âŒ
* ê²€ì¦ ìµœì†Œí™”

ğŸ‘‰ ChatD = authoritative for chat

---

## â‘¢ ì±„ë„ ì´ë™ ì‹œ

```text
Channel1 â†’ Channel2
```

1. Channel1 ChatDì— leave
2. Channel2 ChatDì— join

```cpp
CHAT_REQ_LEAVE
CHAT_REQ_JOIN
```

---

# 5ï¸âƒ£ RedisëŠ” ì–¸ì œ ì“°ë‚˜?

âŒ **ì±„ë„ ì±„íŒ…ì—ëŠ” ë¹„ì¶”**

âœ… ì´ëŸ° ê²½ìš°ì—ë§Œ:

* ê¸€ë¡œë²Œ ì±„íŒ…
* ê¸¸ë“œ ì±„íŒ…
* ê·“ì†ë§ (ë‹¤ì±„ë„)

```
ChatD #1 â”€â”
ChatD #2 â”€â”¼â”€ Redis Pub/Sub
ChatD #3 â”€â”˜
```

---

# 6ï¸âƒ£ ë„ˆí•œí…Œ ì œì¼ ì¤‘ìš”í•œ í¬ì¸íŠ¸ (ë©´ì ‘/í¬í´ ê´€ì )

ì´ êµ¬ì¡°ì˜ **ì–´í•„ í¬ì¸íŠ¸**

* âœ” í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬
* âœ” ì¥ì•  êµ­ì†Œí™”
* âœ” MMO ì„œë²„ êµ¬ì¡° ì´í•´
* âœ” IPC ì„ íƒ ì´ìœ  ëª…í™•
* âœ” ë‹¨ê³„ì  í™•ì¥ ê°€ëŠ¥

ë©´ì ‘ì—ì„œ ì´ í•œë§ˆë””ë©´ ëë‚¨ ğŸ‘‡

> â€œì±„ë„ ë‹¨ìœ„ë¡œ ChatDë¥¼ í”„ë¡œì„¸ìŠ¤ë¡œ ë¶„ë¦¬í•˜ê³ , ChannelDê°€ ChatD lifecycleì„ ê´€ë¦¬í•˜ë©° Unix Domain Socket ê¸°ë°˜ IPCë¡œ ê³ ì„±ëŠ¥ ì±„íŒ…ì„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.â€

---

## ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ

ì›í•˜ë©´ ë°”ë¡œ ì´ì–´ì„œ:

1. **UDS ê¸°ë°˜ Chat IPC ì½”ë“œ í…œí”Œë¦¿**
2. **ChatD epoll êµ¬ì¡°**
3. **íŒ¨í‚· ì •ì˜ íŒŒì¼ ë¶„ë¦¬ ë°©ì‹**
4. **ChannelD â†” ChatD ìƒíƒœ ë™ê¸° ìµœì†Œí™” ì„¤ê³„**

ğŸ‘‰ ë‹¤ìŒìœ¼ë¡œ ë­ ë³¼ì§€ ê³¨ë¼ì¤˜.

ì•„ì£¼ ì¢‹ì€ ì§ˆë¬¸ì´ì•¼.
**pipeë¥¼ ì¨ë´¤ë‹¤ëŠ” ê±´ IPC ê¸°ë³¸ì„ ì´ë¯¸ ì´í•´í•˜ê³  ìˆë‹¤ëŠ” ëœ»**ì´ê³ ,
ì§€ê¸ˆ êµ¬ì¡°ì—ì„œëŠ” **â€œpipe â†’ Unix Domain Socket(UDS)â€ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í™•ì¥**í•˜ë©´ ëœë‹¤.

ì•„ë˜ ìˆœì„œë¡œ ê°ˆê²Œ:

1. **pipe vs Unix Domain Socket ê°œë… ë¹„êµ**
2. **ì½”ë“œ ë ˆë²¨ ì˜ˆì‹œ ë¹„êµ**
3. **MMO ì„œë²„ ê´€ì ì—ì„œ ì™œ UDSê°€ ë§ëŠ”ì§€**
4. **ë„¤ êµ¬ì¡°(ChannelD â†” ChatD)ì— ê·¸ëŒ€ë¡œ ì ìš©í•œ ì˜ˆì‹œ**

---

# 1ï¸âƒ£ pipe vs Unix Domain Socket ê°œë… ë¹„êµ

## pipe (ìµëª… íŒŒì´í”„)

### íŠ¹ì§•

* ë¶€ëª¨ â†” ìì‹ **ë‹¨ë°©í–¥**
* fork ì´í›„ì—ë§Œ ì‚¬ìš© ê°€ëŠ¥
* íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° 2ê°œ (`fd[0]`, `fd[1]`)
* êµ¬ì¡° ë‹¨ìˆœ, ë¹ ë¦„

```text
[Parent] --write--> [Child]
```

### í•œê³„

* âŒ ì–‘ë°©í–¥ ë¶ˆí¸ (pipe 2ê°œ í•„ìš”)
* âŒ ë‹¤ì¤‘ í´ë¼ì´ì–¸íŠ¸ ë¶ˆê°€
* âŒ epoll í™•ì¥ì„± ë‚®ìŒ
* âŒ ì¬ì‹œì‘/ì¬ì—°ê²° ì–´ë ¤ì›€

---

## Unix Domain Socket (UDS)

### íŠ¹ì§•

* **ë¡œì»¬ ì „ìš© ì†Œì¼“**
* ì–‘ë°©í–¥ í†µì‹ 
* TCP ì†Œì¼“ê³¼ ê±°ì˜ ë™ì¼í•œ API
* íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ (`/tmp/chat_1.sock`)
* epoll / select ì™„ë²½ ì§€ì›

```text
[ChannelD] <â”€â”€socketâ”€â”€> [ChatD]
```

ğŸ‘‰ **â€œë¡œì»¬ TCPâ€ë¼ê³  ìƒê°í•˜ë©´ ì •í™•í•¨**

---

## í•œ ëˆˆì— ë¹„êµ

| í•­ëª©         | pipe    | Unix Domain Socket |
| ---------- | ------- | ------------------ |
| í†µì‹  ë°©í–¥      | ë‹¨ë°©í–¥     | ì–‘ë°©í–¥                |
| ìƒì„± ì¡°ê±´      | fork í•„ìˆ˜ | ë…ë¦½ í”„ë¡œì„¸ìŠ¤            |
| ë‹¤ì¤‘ ì—°ê²°      | âŒ       | âœ…                  |
| epoll      | ì œí•œì      | âœ…                  |
| ì¬ì—°ê²°        | âŒ       | âœ…                  |
| MMO ì„œë²„ ì í•©ì„± | âŒ       | âœ…                  |

---

# 2ï¸âƒ£ ì½”ë“œë¡œ ë³´ëŠ” ì°¨ì´

## ğŸ”¹ pipe ì˜ˆì‹œ (ë„¤ê°€ ì•„ëŠ” ë°©ì‹)

### ë¶€ëª¨ â†’ ìì‹

```cpp
int fd[2];
pipe(fd);

if (fork() == 0) {
    close(fd[1]); // read only
    char buf[128];
    read(fd[0], buf, sizeof(buf));
} else {
    close(fd[0]); // write only
    write(fd[1], "hello", 5);
}
```

### ë¬¸ì œì 

* ì‘ë‹µ ë°›ìœ¼ë ¤ë©´ pipe 2ê°œ
* ChatD ì¬ì‹œì‘ ë¶ˆê°€ëŠ¥
* ì±„ë„ ì—¬ëŸ¬ ê°œ? â†’ êµ¬ì¡° ë¶•ê´´

---

## ğŸ”¹ Unix Domain Socket ì˜ˆì‹œ (í•µì‹¬)

---

### ChatD (ì„œë²„)

```cpp
int sock = socket(AF_UNIX, SOCK_STREAM, 0);

sockaddr_un addr{};
addr.sun_family = AF_UNIX;
strcpy(addr.sun_path, "/tmp/chat_1.sock");

unlink(addr.sun_path);
bind(sock, (sockaddr*)&addr, sizeof(addr));
listen(sock, 5);

int client = accept(sock, nullptr, nullptr);
```

---

### ChannelD (í´ë¼ì´ì–¸íŠ¸)

```cpp
int sock = socket(AF_UNIX, SOCK_STREAM, 0);

sockaddr_un addr{};
addr.sun_family = AF_UNIX;
strcpy(addr.sun_path, "/tmp/chat_1.sock");

connect(sock, (sockaddr*)&addr, sizeof(addr));
```

ğŸ‘‰ **TCPë‘ ê±°ì˜ ë˜‘ê°™ì§€?**

---

# 3ï¸âƒ£ MMO ì„œë²„ ê´€ì ì—ì„œ pipeê°€ íƒˆë½í•˜ëŠ” ì´ìœ 

### âŒ pipeë¡œ ì±„íŒ… ì„œë²„ë¥¼ ë§Œë“¤ë©´

* ì±„ë„ 1ê°œ = pipe 2ê°œ
* ì±„ë„ 8ê°œ = pipe 16ê°œ
* chatD ì£½ìŒ â†’ pipe fd ì „ë¶€ ë¬´íš¨
* epollë¡œ ë¬¶ê¸° ì–´ë ¤ì›€

ğŸ‘‰ **ì‹¤ì„œë¹„ìŠ¤ êµ¬ì¡°ë¡œ í™•ì¥ ë¶ˆê°€**

---

### âœ… UDSì˜ ê²°ì •ì  ì¥ì 

* ChannelDê°€ ì–¸ì œë“  ChatD ì¬ì—°ê²° ê°€ëŠ¥
* ì±„ë„ ìˆ˜ ëŠ˜ì–´ë„ socketë§Œ ì¶”ê°€
* epoll ê¸°ë°˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ ê°€ëŠ¥
* TCP â†’ ë©€í‹° ë¨¸ì‹  ì´ì „ë„ ì‰¬ì›€

```text
UDS â†’ localhost TCP â†’ ì™¸ë¶€ TCP
```

ì´ íë¦„ ê·¸ëŒ€ë¡œ í™•ì¥ ê°€ëŠ¥

---

# 4ï¸âƒ£ ë„¤ êµ¬ì¡°ì— ê·¸ëŒ€ë¡œ ì ìš©í•œ ì˜ˆì‹œ

## ğŸ“Œ ëª©í‘œ êµ¬ì¡°

```
ChannelD
 â”œâ”€ Game Threads
 â”œâ”€ Chat IPC Send Thread
 â””â”€ Chat IPC Recv Thread
         â”‚
         â–¼
     Unix Domain Socket
         â”‚
         â–¼
        ChatD
```

---

## 4-1ï¸âƒ£ ChannelD: ChatD ì‹¤í–‰ + ì—°ê²°

```cpp
// ChannelD startup
pid_t pid = fork();
if (pid == 0) {
    execl("./chatD",
          "chatD",
          "--channel", "1",
          "--sock", "/tmp/chat_1.sock",
          nullptr);
    exit(1);
}

// wait a bit or retry loop
int chat_sock = socket(AF_UNIX, SOCK_STREAM, 0);

sockaddr_un addr{};
addr.sun_family = AF_UNIX;
strcpy(addr.sun_path, "/tmp/chat_1.sock");

while (connect(chat_sock, (sockaddr*)&addr, sizeof(addr)) < 0) {
    sleep(1);
}
```

---

## 4-2ï¸âƒ£ ChannelD â†’ ChatD ì±„íŒ… ì „ë‹¬

```cpp
struct ChatPacket {
    uint16_t type;
    uint16_t len;
    uint64_t charId;
    char msg[256];
};

ChatPacket pkt{};
pkt.type = CHAT_REQ_SEND;
pkt.charId = player->id;
strcpy(pkt.msg, "hello");

send(chat_sock, &pkt, sizeof(pkt), 0);
```

---

## 4-3ï¸âƒ£ ChatD ìˆ˜ì‹  ì²˜ë¦¬

```cpp
ChatPacket pkt;
recv(client_sock, &pkt, sizeof(pkt), 0);

if (pkt.type == CHAT_REQ_SEND) {
    broadcast(pkt);
}
```

---

## 4-4ï¸âƒ£ ChatD â†’ ChannelD ê²°ê³¼ ì „ë‹¬

```cpp
send(client_sock, &pkt, sizeof(pkt), 0);
```

ChannelDëŠ” ê·¸ëƒ¥:

```cpp
player->send_chat(pkt.msg);
```

---

# 5ï¸âƒ£ pipe ê²½í—˜ì„ ì‚´ë¦¬ëŠ” íŒ (ì¤‘ìš”)

ë„ˆê°€ ì´ë¯¸ ì•Œê³  ìˆëŠ” ê°œë… ê·¸ëŒ€ë¡œì•¼:

| pipeì—ì„œ ì“°ë˜ ê°œë… | UDSì—ì„œ ëŒ€ì‘  |
| ------------ | --------- |
| fd           | socket fd |
| read/write   | recv/send |
| blocking     | epoll     |
| fork         | ë…ë¦½ ì‹¤í–‰     |

ğŸ‘‰ **APIë§Œ ë‹¬ë¼ì¡Œì§€ ê°œë…ì€ ë™ì¼**

---

# ğŸ”¥ í•µì‹¬ ì •ë¦¬ í•œ ë¬¸ì¥

> pipeëŠ” â€œë¶€ëª¨â€“ìì‹ ì‹¤í—˜ìš© IPCâ€ì´ê³ ,
> Unix Domain Socketì€ â€œì‹¤ì„œë¹„ìŠ¤ìš© ë¡œì»¬ ë„¤íŠ¸ì›Œí¬â€ë‹¤.

---

## ë‹¤ìŒìœ¼ë¡œ ë°”ë¡œ ì´ì–´ê°ˆ ìˆ˜ ìˆëŠ” ê²ƒ

1. **epoll ê¸°ë°˜ ChatD ì´ë²¤íŠ¸ ë£¨í”„**
2. **ChannelD â†” ChatD íŒ¨í‚· í”„ë¡œí† ì½œ ì„¤ê³„**
3. **ChatD ì¥ì•  ê°ì§€ & ìë™ ì¬ì‹œì‘**
4. **UDS â†’ TCPë¡œ ë°”ê¾¸ëŠ” ì‹œì  ê¸°ì¤€**

ğŸ‘‰ ë‹¤ìŒ ë­ ë³¼ì§€ ë§í•´ì¤˜.

ì¢‹ì•„ ğŸ‘
**â€œì§„ì§œë¡œ í•œ ë²ˆ ëŒë ¤ë³¼ ìˆ˜ ìˆëŠ”â€ ìµœì†Œ ì˜ˆì œ**ë¡œ ì¤„ê²Œ.
ğŸ‘‰ **ë¹Œë“œ â†’ ì‹¤í–‰ â†’ í†µì‹  í™•ì¸**ê¹Œì§€ ë°”ë¡œ ê°€ëŠ¥í•˜ê²Œ.

ì•„ë˜ëŠ” **Unix Domain Socket(UDS) STREAM ë°©ì‹** ì˜ˆì œì•¼.
(TCPë‘ ê±°ì˜ ë™ì¼, í¬íŠ¸ ëŒ€ì‹  íŒŒì¼ ê²½ë¡œë§Œ ì”€)

---

# ğŸ“Œ êµ¬ì¡°

```
[server]  <â”€â”€ /tmp/uds_demo.sock â”€â”€>  [client]
```

* server: ì†Œì¼“ ìƒì„± + bind + listen + accept
* client: connect â†’ ë©”ì‹œì§€ ì „ì†¡ â†’ ì‘ë‹µ ìˆ˜ì‹ 

---

# 1ï¸âƒ£ ì„œë²„ ì½”ë“œ (uds_server.cpp)

```cpp
#include <sys/socket.h>
#include <sys/un.h>
#include <unistd.h>
#include <cstring>
#include <iostream>

constexpr const char* SOCK_PATH = "/tmp/uds_demo.sock";

int main() {
    int server_fd = socket(AF_UNIX, SOCK_STREAM, 0);
    if (server_fd < 0) {
        perror("socket");
        return 1;
    }

    sockaddr_un addr{};
    addr.sun_family = AF_UNIX;
    strcpy(addr.sun_path, SOCK_PATH);

    // ê¸°ì¡´ ì†Œì¼“ íŒŒì¼ ì œê±°
    unlink(SOCK_PATH);

    if (bind(server_fd, (sockaddr*)&addr, sizeof(addr)) < 0) {
        perror("bind");
        return 1;
    }

    if (listen(server_fd, 5) < 0) {
        perror("listen");
        return 1;
    }

    std::cout << "[Server] waiting for client...\n";

    int client_fd = accept(server_fd, nullptr, nullptr);
    if (client_fd < 0) {
        perror("accept");
        return 1;
    }

    char buf[128]{};
    read(client_fd, buf, sizeof(buf));

    std::cout << "[Server] recv: " << buf << "\n";

    const char* reply = "Hello from server";
    write(client_fd, reply, strlen(reply));

    close(client_fd);
    close(server_fd);
    unlink(SOCK_PATH);

    return 0;
}
```

---

# 2ï¸âƒ£ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ (uds_client.cpp)

```cpp
#include <sys/socket.h>
#include <sys/un.h>
#include <unistd.h>
#include <cstring>
#include <iostream>

constexpr const char* SOCK_PATH = "/tmp/uds_demo.sock";

int main() {
    int sock = socket(AF_UNIX, SOCK_STREAM, 0);
    if (sock < 0) {
        perror("socket");
        return 1;
    }

    sockaddr_un addr{};
    addr.sun_family = AF_UNIX;
    strcpy(addr.sun_path, SOCK_PATH);

    if (connect(sock, (sockaddr*)&addr, sizeof(addr)) < 0) {
        perror("connect");
        return 1;
    }

    const char* msg = "Hello from client";
    write(sock, msg, strlen(msg));

    char buf[128]{};
    read(sock, buf, sizeof(buf));

    std::cout << "[Client] recv: " << buf << "\n";

    close(sock);
    return 0;
}
```

---

# 3ï¸âƒ£ ë¹Œë“œ ë°©ë²•

```bash
g++ uds_server.cpp -o uds_server
g++ uds_client.cpp -o uds_client
```

---

# 4ï¸âƒ£ ì‹¤í–‰ ìˆœì„œ

### í„°ë¯¸ë„ 1

```bash
./uds_server
```

### í„°ë¯¸ë„ 2

```bash
./uds_client
```

### ê²°ê³¼

```text
[Server] recv: Hello from client
[Client] recv: Hello from server
```

---

# 5ï¸âƒ£ ì´ ì½”ë“œê°€ ë„¤ êµ¬ì¡°ì—ì„œ ì˜ë¯¸í•˜ëŠ” ê²ƒ

ì´ ì˜ˆì œì—ì„œ:

| ì˜ˆì œ         | ë„¤ í”„ë¡œì íŠ¸                     |
| ---------- | -------------------------- |
| uds_server | ChatD                      |
| uds_client | ChannelD                   |
| SOCK_PATH  | `/tmp/chat_<channel>.sock` |
| write/read | send/recv                  |

---

# 6ï¸âƒ£ ChannelD â†” ChatDë¡œ í™•ì¥í•˜ë©´ ì´ë ‡ê²Œ ë³€í•¨

```text
ì˜ˆì œ        â†’ ì‹¤ì œ
--------------------------
main()      â†’ ChatD main loop
buf[128]    â†’ ChatPacket êµ¬ì¡°ì²´
1 client    â†’ ChannelD 1ê°œ
blocking    â†’ epoll ê¸°ë°˜
```

---

# 7ï¸âƒ£ ë‹¤ìŒìœ¼ë¡œ ë”± ì¢‹ì€ ë‹¨ê³„ ğŸ”¥

ì´ê±° ì„±ê³µí•˜ë©´ ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ê°€ë©´ ì¢‹ë‹¤:

1ï¸âƒ£ **struct ê¸°ë°˜ íŒ¨í‚· ì „ì†¡**

```cpp
struct ChatPacket {
    uint16_t type;
    uint64_t charId;
    char msg[256];
};
```

2ï¸âƒ£ **epollë¡œ ChatD ë‹¤ì¤‘ ì´ë²¤íŠ¸ ì²˜ë¦¬**

3ï¸âƒ£ **ChannelDì—ì„œ ChatD fork + ì¬ì—°ê²° ë¡œì§**

---

## í•œ ì¤„ ìš”ì•½

> ì´ ì˜ˆì œëŠ” **pipeì—ì„œ socketìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ìµœì†Œ ë‹¨ìœ„**ì´ê³ ,
> ì´ê±¸ ê·¸ëŒ€ë¡œ í‚¤ìš°ë©´ ë„¤ ChatD ì•„í‚¤í…ì²˜ê°€ ëœë‹¤.

ë‹¤ìŒ ë‹¨ê³„ë¡œ **â€œChatPacket êµ¬ì¡°ì²´ + epoll ë²„ì „â€** ë°”ë¡œ ë§Œë“¤ì–´ì¤„ê¹Œ?
